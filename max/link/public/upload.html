<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload File</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 40px;
        color: #111827;
      }
      .card {
        max-width: 560px;
        padding: 24px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
      }
      button {
        background: #16a34a;
        color: #fff;
        border: none;
        padding: 12px 18px;
        border-radius: 8px;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .status {
        margin-top: 16px;
        padding: 12px;
        border-radius: 8px;
        background: #f3f4f6;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Upload your file</h1>
      <p id="token-status">Checking link...</p>
      <input type="file" id="file" />
      <button id="upload">Upload</button>
      <div id="status" class="status" style="display: none;"></div>
    </div>

    <script>
      // Extract URL search parameters from the current page address
      const params = new URLSearchParams(window.location.search);
      // Retrieve the 'token' value from the query string
      const token = params.get("token");
      // Get references to DOM elements for status updates and button control
      const tokenStatus = document.getElementById("token-status");
      const uploadBtn = document.getElementById("upload");
      const statusBox = document.getElementById("status");

      // Verify the validity of the token with the server on page load
      async function validateToken() {
        // If no token exists in the URL, block the upload immediately
        if (!token) {
          tokenStatus.textContent = "Missing token.";
          uploadBtn.disabled = true;
          return;
        }

        // Call the server-side validation endpoint
        const response = await fetch(`/api/link/${token}`);
        // Parse the validation result
        const data = await response.json();
        // Update UI based on whether the server confirmed the token is valid/unexpired
        if (!data.valid) {
          tokenStatus.textContent = "This link is invalid or expired.";
          uploadBtn.disabled = true;
        } else {
          tokenStatus.textContent = "Link is valid. Choose a file to upload.";
        }
      }

      // Handle the file upload process
      async function uploadFile() {
        // Reference the file input field
        const fileInput = document.getElementById("file");
        // Check if the user has actually selected a file
        if (!fileInput.files.length) {
          statusBox.textContent = "Please select a file first.";
          statusBox.style.display = "block";
          return;
        }

        // Create a FormData object to handle the multipart file upload
        const formData = new FormData();
        // Append the chosen file to the form data object
        formData.append("file", fileInput.files[0]);
        // Disable the button to prevent double-uploading
        uploadBtn.disabled = true;

        try {
          // Send the file to the server using the POST method
          const response = await fetch(`/api/upload/${token}`, {
            method: "POST",
            body: formData,
          });
          // Parse the server's JSON response
          const data = await response.json();
          // If the server returned an error status, throw an exception
          if (!response.ok) {
            throw new Error(data.error || "Upload failed");
          }
          // Display the final success message and the server's assigned filename
          statusBox.textContent = `Upload complete. Stored as ${data.filename}`;
        } catch (err) {
          // Catch and display any network or server errors
          statusBox.textContent = err.message;
        } finally {
          // Reveal the status message box and re-enable UI if needed
          statusBox.style.display = "block";
          uploadBtn.disabled = false;
        }
      }

      // Execute upload function when user clicks the button
      uploadBtn.addEventListener("click", uploadFile);
      // Automatically run validation when the page finishes loading
      validateToken();
    </script>
  </body>
</html>
